<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.runjian.auth.server.mapper.MenuInfoMapper">

    <select id="selectByAppId" resultType="com.runjian.auth.server.domain.entity.MenuInfo">
        SELECT
            menu.id,
            menu.app_id,
            menu.menu_pid,
            menu.menu_pids,
            menu.menu_sort,
            menu.name,
            menu.leaf,
            menu.path,
            menu.component,
            menu.name,
            menu.icon,
            menu.title,
            menu.level,
            menu.hidden,
            menu.status
        FROM
            menu_info menu
        <where>
            menu.delete_flag = 0
            <if test="appId != null">
                AND menu.app_id = #{appId,jdbcType=BIGINT} OR menu.app_id = 0
            </if>
        </where>
        ORDER BY menu.level,menu.menu_sort,menu.id
    </select>

    <select id="selectMenuByRoleCode" resultType="com.runjian.auth.server.domain.entity.MenuInfo">
        SELECT smi.*
        FROM menu_info smi
            LEFT JOIN role_menu srm ON srm.menu_id = smi.id
            LEFT JOIN role_info sri ON sri.id = srm.role_id
        WHERE sri.status = 0
        AND sri.role_code = #{roleCode}
    </select>

    <select id="findMenuIdListByRoleId" resultType="java.lang.Long">
        SELECT org_id
        FROM role_org
        WHERE role_org.role_id = #{roleId,jdbcType=BIGINT}
    </select>

    <select id="selectMenuList" resultType="com.runjian.auth.server.domain.entity.MenuInfo">
        WITH RECURSIVE menu_path AS (
            SELECT menu.*
            FROM menu_info menu
            WHERE menu.delete_flag = 0
              AND menu.app_id = #{appId,jdbcType=BIGINT}
              AND menu.id IN
            <foreach collection="menuIds" item="menuId" index="index" open="(" close=")" separator=",">
                #{menuId,jdbcType=BIGINT}
            </foreach>
            UNION ALL
            SELECT va.*
            FROM menu_info va
                JOIN menu_path ap ON va.id = ap.menu_pid
            WHERE va.delete_flag = 0
        )
        SELECT *
        FROM menu_path ap
    </select>
</mapper>
